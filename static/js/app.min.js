function getValue(key) {
    var url_string = window.location.href
    var url = new URL(url_string);
    return url.searchParams.get(key);
}

function init() {
    jwplayer.key = "W7zSm81+mmIsg7F+fyHRKhF3ggLkTqtGMhvI92kbqf/ysE99";

    let xml = getValue("ads")
    let advertising
    if (xml) {
        advertising = {
            client: 'vast',
            'skipoffset': 5,
            schedule: { "myAds1": { "offset": "pre", "tag": xml } },
            "loadingAd": "Đang tải quảng cáo",
            admessage: "Quảng cáo sẽ đóng sau xx giây.",
            skipmessage: "Bỏ qua quảng cáo sau xx giây.",
            skiptext: "Bỏ qua quảng cáo",
        }
    }

    var playerInstance = jwplayer("player");
    playerInstance.setup({
        "playlist": [{
            image: getValue("image"),
            "sources": [{
                default: false,
                type: "hls",
                file: `https://m3u8.gostream.video//hls/60ec51bb0fead82815ceff82/60ed45f10fead82815cf093e/playlist.m3u8`,
                label: "0"
            }]
        }],
        advertising,
        primary: "html5",
        hlshtml: true,
        autostart: getValue("autoplay") === "1" ? true : false,
        width: "100%",
        height: "100vh",
    });
    playerInstance.on("ready", function() {
        if (getValue("autoplay") === "1") {
            setTimeout(() => {
                playerInstance.play()
            }, 2000);
        }
        playerInstance.addButton("/play-gostream/static/img/forward.svg", "Forward 15 seconds", function() {
            playerInstance.seek(playerInstance.getPosition() + 15);
        }, "Forward 15 seconds");
        playerInstance.addButton("/play-gostream/static/img/backward.svg", "Rewind 15 seconds", function() {
            playerInstance.seek(playerInstance.getPosition() - 15);
        }, "Rewind 15 seconds");
    });

    jwplayer_hls_provider.attach();
    initJwPlayer(playerInstance)
}

function initJwPlayer(player) {
    const iid = setInterval(() => {
        if (player.hls && player.hls.config) {
            clearInterval(iid);
            player.hls.on("hlsFragChanged", (_event, data) => {
                const frag = data.frag;
                console.log(frag)
            });
        }
    }, 200);
}

function Html404() {
    document.getElementById("player").innerHTML = '<div class="number home">404</div> <div class="text home"><span>Ooops...</span><br>page not found</div>';
        window.console = window.console || function(t) {};
        if (document.location.search.match(/type=embed/gi)) {
            window.parent.postMessage("resize", "*");
        }
}

const url = (window.location != window.parent.location)
    ? document.referrer
    : document.location.href;

if (url && url.includes("play.gostream.video")) {
    Html404()
} else {
    init()
}
